(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
var Stories = require('./stories.jsx');
var Settings = require('./settings.jsx');


var River = React.createClass({displayName: "River",
  getInitialState: function getInitialState() {
    return {
      panel: ''
    };
  },

  togglePanel: function togglePanel(panel) {
    this.setState({
      panel: panel
    });
  },
  
  render: function render() {
    var that = this;

    var login = localStorage.getItem('login');
    var token = localStorage.getItem('token');

    var panel = '';

    if(that.state.panel === 'settings')
      panel = (React.createElement(Settings, {login: login, token: token, settingsChanged: this.forceUpdate}));
    else if(that.state.panel === 'subscription')
      panel = (React.createElement(Subscriptions, null));
    else
      panel = (React.createElement(Stories, {login: login, token: token}));

    // if(this.state.showSettings) {
    //   settingsNode = (<Settings />);
    // }

    // var loading = '';
    // if(this.state.loading) {
    //   loading = (<div className="panel-body"><p className="text-center"><span className="glyphicon glyphicon-refresh" aria-hidden="true"></span></p></div>)
    // }

    // var error = '';
    // if(this.state.error) {
    //   loading = (<div className="panel-body"><p className="text-center">{this.state.error}</p></div>)
    // }


    var settingsButtonClasses = ["btn", "btn-default", "pull-right"];
    if(that.state.panel) {
      settingsButtonClasses.push("active")
    }

    var settingsButton = (React.createElement("button", {type: "button", className: settingsButtonClasses.join(' '), onClick: function() {
      that.togglePanel(that.state.panel == 'settings' ? '' : 'settings')
    }}, 
      React.createElement("span", {className: "glyphicon glyphicon-wrench", "aria-hidden": "true"})
    ));

    return (
      React.createElement("div", {className: "panel panel-default"}, 

        React.createElement("div", {className: "panel-heading clearfix"}, 
          settingsButton
        ), 
        
        panel, 

        React.createElement("div", {className: "panel-footer"}, "Made with ", React.createElement("a", {href: "https://push.superfeedr.com"}, "Superfeedr"), ". ", React.createElement("a", {href: "https://github.com/superfeedr/readernews"}, "Source code"), ".")
      )
    );
  }
});


React.render(
  React.createElement(River, null),
  document.getElementById('content')
);

},{"./settings.jsx":2,"./stories.jsx":3}],2:[function(require,module,exports){
var Superfeedr = require('./utils/superfeedr.js');

var Settings = React.createClass({displayName: "Settings",

  getInitialState: function() {
    return {
      loading: false,
      valid: false,
    }
  },

  saveSettings: function(e) {
    var that = this;
    e.preventDefault();
    var login = React.findDOMNode(this.refs.login).value.trim();
    var token = React.findDOMNode(this.refs.token).value.trim();
    if (!token || !login) {
      return;
    }
    React.findDOMNode(this.refs.login).value = login;
    React.findDOMNode(this.refs.token).value = token;


    that.setState({
      valid: false,
      loading: true
    }, function() {
      Superfeedr.checkCredentials(login, token, function(error, valid) {
        if(error || !valid) {
          that.setState({
            loading: false
          }, function() {
            if(error.status == '401' || error.status == '403')
              alert('Your credentials are not valid. Please, try again.');
            else
              alert('We could not check your credentials. Please try again later.');
          });
        }
        else {
          that.setState({
            loading: false,
            valid: true
          }, function() {
            localStorage.setItem("login", login);
            localStorage.setItem("token", token);
            that.props.settingsChanged();
          });
        }
      });
    });

  },

  render: function() {

    var button = (React.createElement("button", {type: "submit", className: "btn btn-default pull-right"}, "Save"));
    if(this.state.loading) {
      button = (React.createElement("button", {type: "submit", className: "btn btn-default pull-right"}, 
        React.createElement("span", {className: "glyphicon glyphicon glyphicon-refresh", disabled: "disabled", "aria-hidden": "true"}), " Saving"
        ));
    }
    if(this.state.valid) {
      button = (React.createElement("button", {type: "submit", className: "btn btn-success pull-right"}, 
        React.createElement("span", {className: "glyphicon glyphicon-ok", "aria-hidden": "true"}), " Saved"
        ));
    }

    return (
    React.createElement("form", {className: "panel-body", onSubmit: this.saveSettings}, 
      React.createElement("div", {className: "form-group"}, 
        React.createElement("label", {htmlFor: "login"}, "Login"), 
        React.createElement("input", {type: "text", className: "form-control", ref: "login", placeholder: "Login", defaultValue: this.props.login})
      ), 
      React.createElement("div", {className: "form-group"}, 
        React.createElement("label", {htmlFor: "token"}, "Token"), 
        React.createElement("input", {type: "text", className: "form-control", ref: "token", placeholder: "Token", defaultValue: this.props.token})
      ), 
      button
    ));
  }
});


module.exports = Settings;

},{"./utils/superfeedr.js":6}],3:[function(require,module,exports){
var serialize = require('./utils/serialize.js');

var Story = require('./story.jsx');

var Stories = React.createClass({displayName: "Stories",

  getInitialState: function() {
   return {
    stories: [],
   }
  },

  componentDidMount: function() {
    this.loadContent();
  },

  loadContent: function loadContent() {
    var that = this;
    this.setState({
      error: false,
      loading: true
    }, function() {

      var url = "https://stream.superfeedr.com/";
      var query = {
        'count': 5,
        'hub.mode': 'retrieve',
        'authorization': btoa([that.props.login, that.props.token].join(':')),
        'hub.callback': 'https://push.superfeedr.com/dev/null'
      };

      url = [url, serialize(query)].join('?');
      var source = new EventSource(url);

      source.addEventListener("error", function(e) {
        that.setState({
          loading: false,
          error: "There was an error. Please, check your credentials."
        });
      });

      source.addEventListener("notification", function(e) {
        var notification = JSON.parse(e.data);
        notification.items.sort(function(x, y) {
          return x.published - y.published;
        });
        notification.items.forEach(function(item) {
          if(!item.source)
            item.source = {
              title: notification.title,
              permalinkUrl: notification.permalinkUrl
            }
            that.state.stories.unshift(item);
            that.setState({
              loading: false,
              stories: that.state.stories
            });
          });
      });
    });
  },


  render: function() {
    var storyNodes = this.state.stories.map(function (story) {
      return (
        React.createElement(Story, {key: story.id, story: story}
        )
        );
    });

    return (        React.createElement("div", {className: "list-group"}, 

      storyNodes
      )
)

  }
});


module.exports = Stories;

},{"./story.jsx":4,"./utils/serialize.js":5}],4:[function(require,module,exports){
var Story = React.createClass({displayName: "Story",
  render: function() {
    var source = {
      title: "",
      url: "",
      icon: ""
    };
    if(this.props.story.source) {
      source.title = this.props.story.source.title;      
      source.icon = "http://www.google.com/s2/favicons?domain=" + encodeURIComponent(this.props.story.source.permalinkUrl);
      source.url = this.props.story.source.permalinkUrl;
    }
    var published = new Date(this.props.story.published * 1000).toUTCString();
    return (
    React.createElement("a", {href: this.props.story.permalinkUrl, target: "_blank", className: "list-group-item"}, 
      React.createElement("h4", {className: "list-group-item-heading"}, this.props.story.title), 
      React.createElement("span", {className: "source"}, React.createElement("img", {src: source.icon}), source.title, ", published ", published)
    )
    );
  }
});


module.exports = Story;

},{}],5:[function(require,module,exports){
function serialize(object, prefix) {
  var q = [];
  for(var k in object) {
    if (object.hasOwnProperty(k)) {
      var k = prefix ? prefix + "[" + k + "]" : k, v = object[k];
      q.push(typeof v == "object" ? serialize(v, k) : encodeURIComponent(k) + "=" + encodeURIComponent(v));
    }
  }
  return q.join("&");
}

module.exports = serialize;

},{}],6:[function(require,module,exports){
var serialize = require('./serialize.js');

module.exports = {

	checkCredentials: function checkCredentials(login, token, callback) {
		
		var url = "https://push.superfeedr.com/";
		var query = {
			'rights': true,
			'hub.mode': 'authenticate',
			'authorization': btoa([login, token].join(':'))
		};

		url = [url, serialize(query)].join('?');

		var http = new XMLHttpRequest();
		http.onreadystatechange = function() { 
			if(http.readyState == 4) {
				if(http.status == 200) 
					return callback(null, true);
				else
					return callback({status: http.status, message: http.responseText});
			}
		}

    http.open("GET", url, true); // true for asynchronous 
    http.send(null);
  }

};

},{"./serialize.js":5}]},{},[1]);
